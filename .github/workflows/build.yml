name: Build Ruby

on: [push, pull_request]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    name: ${{ matrix.os }} (${{ matrix.arch }}-bit)
    strategy:
      fail-fast: false
      matrix:
        os:
        - ubuntu-20.04
        arch:
        - 64
    env:
      RUBY_TAG: v2_7_2
    steps:
    - name: Set up environment
      run: |
        echo "RUBY_PREFIX=$HOME/ruby-install" >> $GITHUB_ENV
    - name: Clone ruby-build
      uses: actions/checkout@v2
    - name: Clone Ruby
      run: |
        git clone --depth 1 git://github.com/ruby/ruby -b "$RUBY_TAG"
        echo "RUBY_SOURCE=$(pwd)/ruby" >> $GITHUB_ENV
    - name: Configure
      run: ./scripts/configure.bash
    - name: Build
      run: ./scripts/build.bash
    - name: Test
      run: ./scripts/test.bash
    - name: Package
      run: |
        mkdir ruby-package
        ./scripts/package.bash "$(pwd)/ruby-package"
